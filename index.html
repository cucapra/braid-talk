<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">

  <title>Static Stages for Heterogeneous Programming</title>

  <link rel="stylesheet" href="node_modules/reveal.js/css/reveal.css">
  <link rel="stylesheet" href="node_modules/reveal.js/css/theme/white.css">
  <link rel="stylesheet" href="rsrc/dingus.css">
  <link rel="stylesheet" href="rsrc/codemirror.css">
  <link rel="stylesheet" href="talk.css">
  <link rel="stylesheet" href="node_modules/highlight.js/styles/github-gist.css">

  <script src="node_modules/headjs/dist/1.0.0/head.min.js"></script>
</head>
<body>
<div class="reveal">
<div class="slides">

<section data-example="webgl">
  <script type="text/example" data-preamble="1">
var model = mat4.create();

# Load buffers and parameters for the model.
var mesh = load_obj("bunny.obj");
var position = mesh_positions(mesh);
var normal = mesh_normals(mesh);
var indices = mesh_indices(mesh);
var size = mesh_size(mesh);

var model = mat4.create();
mat4.scale(model, model, vec3(8.0, 8.0, 8.0));
  </script>
  <script type="text/example">
render js<
 vertex glsl<
  gl_Position = projection * view *
   model * vec4(position, 1.0);
  fragment glsl<
   gl_FragColor =
    vec4(abs(normal), 1.0);
  >
 >;
 draw_mesh(indices, size);
>
  </script>
</section>

<section data-example="interp">
  <script type="text/example">
2 * 2 * 2
  </script>
</section>

<section data-example="interp">
  <h2>Quote</h2>
  <script type="text/example">
< 2 * 2 * 2 >
  </script>
</section>

<section data-example="interp">
  <h2>Run</h2>
  <script type="text/example">
!< 2 * 2 * 2 >
  </script>
</section>

<section data-example="interp">
  <h2>Splice</h2>
  <script type="text/example">
var x = <2>;
!< [x] * 2 * 2 >
  </script>
</section>
<!-- Then remove the ! to show the code itself. -->

<section data-example="interp">
  <h2>Types for code</h2>
  <script type="text/example">
def square(x: <Int>)
  < [x] * [x] >;
square(<3>)
  </script>
</section>
<!-- Then *add* a ! to show that the code value "works." -->
<!-- Then change one to a string to show a type error. -->

<section>
  <h4>
    Multi-stage programming guarantees that
    <strong>any generated program will be well-typed.</strong>
  </h4>
</section>
<!-- TODO Semantics here? -->

<section data-example="interp">
  <h2>Communication through literals</h2>
  <script type="text/example">
var x = 2;
< [x] * 21 >
  </script>
</section>
<!-- Change 2 to <2> to show lifting. -->

<section data-example="interp">
  <h2>
    Braid&rsquo;s new construct:<br>
    Materialization
  </h2>
  <script type="text/example">
var x = 2;
< %[x] * 21 >
  </script>
</section>
<!-- Add ! to show result of executing the opaque value. -->
<!-- Perhaps show splicing being combined? -->

<section>
  <h2>
    Backend annotations<br>
    in BraidGL
  </h2>
  <p>
    <code>js&lt;...&gt;</code>: Emit JavaScript for the CPU.
  </p>
  <p>
    <code>glsl&lt;...&gt;</code>: Emit GLSL for GPU shaders.
  </p>
</section>

<section data-example="webgl">
  <script type="text/example" data-preamble="1">
# Load buffers and parameters for the model.
var mesh = load_obj("teapot.obj");
var indices = mesh_indices(mesh);
var size = mesh_size(mesh);

# Position the model.
var model = mat4.create();
mat4.translate(model, model, vec3(0.0, -3.0, 0.0));
mat4.scale(model, model, vec3(0.3, 0.3, 0.3));
mat4.rotateX(model, model, -1.0);
  </script>
  <script type="text/example">
# Get the geometry for the teapot.
var position = mesh_positions(mesh);
var normal = mesh_normals(mesh);

# Render each frame.
render js<
  var tr = projection * view * model;

  vertex glsl<
    gl_Position = tr * vec4(position, 1.0);

    fragment glsl<
      gl_FragColor = vec4(0.32, 0.63, 0.07, 1.0);
    >
  >;

  draw_mesh(indices, size);
>
  </script>
</section>
<!-- Change the colors to abs(normal). -->

<section data-example="webgl">
  <script type="text/example" data-preamble="1">
# Phong shader.
def phong(pos: Float3 Buffer, norm: Float3 Buffer, model: Mat4, lightpos: Vec3, color: Vec3, specular: Float) (
  var camera_pos = eye(view);

  vertex glsl<
    gl_Position = projection * view * model * vec4(pos, 1.0);

    fragment glsl<
      # Convert to world space.
      var position_world = vec3(model * vec4(pos, 1.0));
      var normal_world = normalize(vec3(model * vec4(norm, 0.0)));
      var view_dir_world = normalize(camera_pos - position_world);

      # Light.
      var light_direction = normalize(lightpos - position_world);

      # Diffuse.
      var ndl = vec3( max(0.0, dot(normal_world, light_direction)) );

      # Specular.
      var angle = normalize(view_dir_world + light_direction);
      var spec_comp_b = max(0.0, dot(normal_world, angle));
      var spec_comp = pow( spec_comp_b, max(1.0, specular) ) * 2.0;

      gl_FragColor = vec4(color * ndl + vec3(spec_comp), 1.0);
    >
  >;
);

# ---

# Load buffers and parameters for the main model.
var mesh = load_obj("bunny.obj");
var position = mesh_positions(mesh);
var normal = mesh_normals(mesh);
var indices = mesh_indices(mesh);
var size = mesh_size(mesh);

# Position the model.
var id = mat4.create();
var model = mat4.create();
mat4.translate(model, model, vec3(0.0, -10.0, 0.0));
mat4.scale(model, model, vec3(10.0, 10.0, 10.0));

# The parameters for the Phong shader.
var specular = 100.0;
var light_color = vec3(0.32, 0.63, 0.07);
var light_position = vec3(20.0, 0.0, 20.0);

# Rotation matrix.
var rot = mat4.create();
  </script>
  <script type="text/example">
render js<
  # Rotation animation.
  var t = Date.now();
  mat4.rotateY(rot, id, t / 1000);

  phong(position, normal, rot * model, light_position, light_color, specular);
  draw_mesh(indices, size);
>
  </script>
</section>
<!-- TODO: Show the actual computation! And make a specialization change? -->

</div>
</div>

<!-- The dingus DOM, which gets reused on all code slides. -->
<div class="sscdingus">
  <div class="input">
      <textarea class="code"></textarea>
  </div>

  <div class="arrow">
    âž¡
  </div>

  <div class="output">
      <div class="error"></div>
      <div class="primary">
        <pre class="result"></pre>
        <div class="visual"></div>
        <div class="fps"></div>
      </div>
      <div class="secondary">
        <pre class="compiled"></pre>
      </div>
  </div>
</div>

<script src="node_modules/reveal.js/js/reveal.js"></script>
<script src="rsrc/ssc.bundle.js"></script>
<script src="talk.js"></script>

</body>
</html>
